---
title: "Normalize Phenotypes Total"
author: "Briana Mittleman"
date: "10/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(ggpubr)
library(tidyverse)
library(reshape2)
```



```{r}
humanPheno=read.table("../data/Pheno_5perc/ALLPAS_postLift_LocParsed_Human_Pheno_5perc.txt",stringsAsFactors = F, header = T)
chimpPheno=read.table("../data/Pheno_5perc/ALLPAS_postLift_LocParsed_Chimp_Pheno_5perc.txt",stringsAsFactors = F, header = T)


allPhenoT=humanPheno %>% full_join(chimpPheno,by="chrom") %>% select(-contains("_N"))
```


```{bash,eval=F}
mkdir ../data/Pheno_5perc_total
```

```{r}
write.table(allPhenoT, "../data/Pheno_5perc_total/ALLPAS_postLift_LocParsed_bothSpecies_pheno_5perc_Total.txt", col.names = T, row.names = F, quote = F)

```


```{bash,eval=F}

gzip ../data/Pheno_5perc_total/ALLPAS_postLift_LocParsed_bothSpecies_pheno_5perc_Total.txt

#conda deactivate 
conda deactivate 
conda deactivate 
#python 2
source ~/activate_anaconda_python2.sh 
#go to directory ../data/Pheno_5perc_total/
python ../../code/prepare_phenotype_table.py ALLPAS_postLift_LocParsed_bothSpecies_pheno_5perc_Total.txt.gz
cat ALLPAS_postLift_LocParsed_bothSpecies_pheno_5perc_Total.txt.gz.phen_chr* > ALLPAS_postLift_LocParsed_bothSpecies_pheno_5perc_Total.txt.gz.phen_AllChrom
```


Use these normalized phenotypes for the PCA 

```{r}
metaDataT=read.table("../data/metadata_HCpanel.txt", header = T, stringsAsFactors = F) %>% filter(Fraction=="Total")
```


```{r}
normPheno=read.table("../data/Pheno_5perc_total/ALLPAS_postLift_LocParsed_bothSpecies_pheno_5perc_Total.txt.gz.phen_AllChrom", col.names = c('Chr',	'start',	'end',	'ID',	'18498_T',		'18499_T',		'18502_T',		'18504_T',	'18510_T',	'18523_T',	'18358_T','3622_T',		'3659_T',	'4973_T',	'pt30_T',		'pt91_T'))

normPheno_matrix=as.matrix(normPheno %>% select(-Chr, -start, -end, -ID))
```

Run PCA:  

```{r}
pca_Pheno=prcomp(normPheno_matrix, center=T,scale=T)
pca_df=as.data.frame(pca_Pheno$rotation) %>% rownames_to_column(var="ID")

```

```{r}
eigs <- pca_Pheno$sdev^2
proportion = eigs/sum(eigs)

plot(proportion)
```
```{r}
top2PC=pca_df %>% select(ID, PC1, PC2) %>% inner_join(metaDataT, by="ID")


ggplot(top2PC,aes(x=PC1, y=PC2, col=Species)) + geom_point(size=3) + geom_text(aes(label=Line), position = position_nudge(y = 0.03) )
```

```{r}
covariate_pc_pve_heatmap <- function(pc_df, covariate_df, title) {
  # Load in data
  pcs <- pc_df
  #pcs=pca_df

  covs <- covariate_df
  #covs= metaData_sm


  # Remove unimportant columns
  pcs <- as.matrix(pcs[,2:dim(pcs)[[2]]])
  covs <- data.frame(as.matrix(covs[,1:dim(covs)[[2]]]))

  # Initialize PVE heatmap
  pve_map <- matrix(0, dim(covs)[2], dim(pcs)[2])
  colnames(pve_map) <- colnames(pcs)
  rownames(pve_map) <- colnames(covs)

  # Loop through each PC, COV Pair and take correlation
  num_pcs <- dim(pcs)[2]
  num_covs <- dim(covs)[2]
  for (num_pc in 1:num_pcs) {
    for (num_cov in 1:num_covs) {
      pc_vec <- pcs[,num_pc]
      cov_vec <- covs[,num_cov]
      lin_model <- lm(pc_vec ~ cov_vec)
      pve_map[num_cov, num_pc] <- summary(lin_model)$adj.r.squared
      if (pve_map[num_cov, num_pc] <0){pve_map[num_cov, num_pc]=0}
    }
  }
  pve_map
  ord <- hclust( dist(scale(pve_map), method = "euclidean"), method = "ward.D" )$order

  melted_mat <- melt(pve_map)
  colnames(melted_mat) <- c("Covariate", "PC","PVE")

  #  Use factors to represent covariate and pc name
  melted_mat$Covariate <- factor(melted_mat$Covariate, levels = rownames(pve_map)[ord])
  melted_mat$PC <- factor(melted_mat$PC)
  if (dim(pcs)[2] == 10) {
    levels(melted_mat$PC) <- c(levels(melted_mat$PC)[1],levels(melted_mat$PC)[3:10],levels(melted_mat$PC)[2])
  }
  if (dim(pcs)[2] == 21) {
    levels(melted_mat$PC) <- c(levels(melted_mat$PC)[1],levels(melted_mat$PC)[12],levels(melted_mat$PC)[15:21],levels(melted_mat$PC)[2:11], levels(melted_mat$PC)[13:14])
  }

  #  PLOT!
  heatmap <- ggplot(data=melted_mat, aes(x=Covariate, y=PC)) + geom_tile(aes(fill=PVE)) + scale_fill_gradient2(midpoint=-.05, guide="colorbar")
  heatmap <- heatmap + theme(text = element_text(size=14), panel.background = element_blank(), axis.text.x = element_text(angle = 90, vjust=.5))
  heatmap <- heatmap + labs(y="latent factor", title=title)

  # Save File
  return(heatmap)
}


```


```{r}

metaData_sm= metaDataT %>% select(-ID,-Line,-FQlines,-Reads,-Mapped_wMP,-Mapped_Clean,-PerMap,-PerMapClean,-Fraction,-Cq, -Rerun, -Library_concentration)
covariate_pc_pve_heatmap(pca_df,metaData_sm, title="PCs")
```


```{r}
ggplot(metaDataT, aes(x=Species, y=Concentration, fill=Species)) + geom_boxplot() + stat_compare_means(method = "t.test") + scale_fill_brewer(palette = "Dark2")
```

