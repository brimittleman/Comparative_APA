---
title: "Can signal site explain differential usage"
author: "Briana Mittleman"
date: "1/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this analysis, I will ask if presence or absense of a signal site in either species can explain the diffentially used PAS. I can do overlaps and look at correlations.  

```{r}
library(workflowr)
library(RColorBrewer)
library(ggpubr)
library(tidyverse)
```

```{r}
MetaPAS=read.table("../data/PAS_doubleFilter/PAS_5perc_either_HumanCoord_BothUsage_meta_doubleFilter_withSSTop2.txt", header = T, stringsAsFactors = F)
```

Pull in the differentiall used PAS:  

```{r}
DiffUsed=read.table("../data/DiffIso_Nuclear_DF/SignifianceEitherPAS_2_Nuclear.txt", header = T, stringsAsFactors = F) %>% rename("Human_NormUse"=Human, "Chimp_NormUse"=Chimp)
```


Join this by chr, start,end, gene  

```{r}
DiffUsed_anno=DiffUsed %>% inner_join(MetaPAS,by=c("chr","start", "end","gene"))
```

Ask how many of the effect size either way are those with SS in one species  

+ upreg in chimp
- upred in human 
```{r}
DiffUsed_anno_humanup=DiffUsed_anno %>% filter(deltaPAU<0)
nrow(DiffUsed_anno_humanup)

nrow(DiffUsed_anno_humanup %>% filter(HumanTopSS=="Yes", ChimpTopSS=="No"))


DiffUsed_anno_chimpup=DiffUsed_anno %>% filter(deltaPAU>0)
nrow(DiffUsed_anno_chimpup)

nrow(DiffUsed_anno_chimpup %>% filter(HumanTopSS=="No", ChimpTopSS=="Yes"))
```

This means that of the 3132 only 18 are in PAS where signal site could account for it.  

Significance:  


```{r}
humanOnly=nrow(MetaPAS %>%  filter(HumanTopSS=="Yes", ChimpTopSS=="No"))

chimpOnly=nrow(MetaPAS %>%  filter(HumanTopSS=="No", ChimpTopSS=="Yes"))

humanOnly+chimpOnly

```
Of the 46494 we see that 768 have the pattern of interest. We choose 3076 of them and 19 come out.  Look to see if it is more than expected by change 

phyper(success in sample, sucesss in possible, failure possible, sample size)

```{r}
x= 18
m= 768
n=46494
k=3132


#expected
which(grepl(max(dhyper(1:x, m, n, k)), dhyper(1:x, m, n, k)))




phyper(18,768, 46494 , 3132,lower.tail=F)
```
No significant enrichment for the pattern.  


Plot dPAU by presence and absense:



```{r}
ggplot(DiffUsed_anno_humanup,aes(y=abs(deltaPAU), x=HumanTopSS))+ geom_boxplot()+ stat_compare_means() + labs(title="Human upregualted PAS by presence of Signal")


ggplot(DiffUsed_anno_humanup,aes(x=abs(deltaPAU), by=HumanTopSS, fill=HumanTopSS))+ geom_density(alpha=.5)+  labs(title="Human upregualted PAS by presence of Signal") + scale_fill_discrete(name="Human Signal Site Detected")


```
Test with wilcoxan test:  



There is a shift. 


```{r}
ggplot(DiffUsed_anno_chimpup,aes(x=ChimpTopSS, y=abs(deltaPAU))) + geom_boxplot() + stat_compare_means() + labs(title="Chimp upregualted PAS by presence of Signal")


ggplot(DiffUsed_anno_chimpup,aes(x=abs(deltaPAU), by=ChimpTopSS, fill=ChimpTopSS))+ geom_density(alpha=.5)+  labs(title="Chimp upregualted PAS by presence of Signal") + scale_fill_discrete(name="Chimp Signal Site Detected") + annotate("text",label="Wilcoxon, p=0.035",x=.8,y=7.5)
```

It does not look like presence of a signal within the upregulated matters.  

Overall it does not look like presense of a signal site or not can explain the differences.   

Opposite direction:  

```{r}
nrow(DiffUsed_anno_humanup %>% filter(HumanTopSS=="No", ChimpTopSS=="Yes"))

nrow(DiffUsed_anno_chimpup %>% filter(HumanTopSS=="Yes", ChimpTopSS=="No"))
```


Look at the regions that have a non cononical signal site.  

I choose these is the original SS analysis. I used the chooseSignalSite.py it was a hierarchical model 
```{r}
MetaAllSS=read.table("../data/PAS_doubleFilter/PAS_5perc_either_HumanCoord_BothUsage_meta_doubleFilter_withSS.txt",stringsAsFactors = F,header = T)
MetaAllSSsmall=MetaAllSS %>% select(chr, start,end,PAS)
```

This has every PAS with a signal site. I will add information about if the PAS is differentially used.  

```{r}
DiffUsed_small= DiffUsed %>% select(chr,start,end, gene, deltaPAU, p.adjust) %>% inner_join(MetaAllSSsmall,by=c("chr",'start','end'))

DiffUsed_small_human= DiffUsed_small %>% filter(deltaPAU<0)
DiffUsed_small_chimp= DiffUsed_small %>% filter(deltaPAU>0)

MetaAllSS_diffUsage=MetaAllSS %>% mutate(DiffUsed=ifelse(PAS %in% DiffUsed_small$PAS, "yes","no"), HumanUp=ifelse(PAS %in% DiffUsed_small_human$PAS, "yes","no"), ChimpUp=ifelse(PAS %in% DiffUsed_small_chimp$PAS, "yes","no"))
```

First question: 
Are there cononical in one and non connonical in the other species

```{r}
con=c("AATAAA", "ATTAAA")
non=c('AAAAAG', 'AAAAAA', 'TATAAA', 'AATATA', 'AGTAAA', 'AATACA', 'GATAAA', 'AATAGA', 'CATAAA', 'ACTAAA')
ChimpConHumanNon=MetaAllSS_diffUsage %>% filter(ChimpPAS %in% con, HumanPAS %in% non) 
nrow(ChimpConHumanNon)

#number up in chim
ChimpConHumanNon %>% filter(ChimpUp=="yes") %>% nrow()

#number up in human  

ChimpConHumanNon %>% filter(HumanUp=="yes") %>% nrow()

```

Opposite direction: 

```{r}
ChimpNonHumanCon=MetaAllSS_diffUsage %>% filter(ChimpPAS %in% non, HumanPAS %in% con) 
nrow(ChimpNonHumanCon)

#number up in chim
ChimpNonHumanCon %>% filter(ChimpUp=="yes") %>% nrow()

#number up in human  

ChimpNonHumanCon %>% filter(HumanUp=="yes") %>% nrow()

```
This doesnt make a lot of sense.  


Question 2: any signal site vs no signal site?  


```{r}
MetaAllSS_diffUsage_add=MetaAllSS_diffUsage %>% mutate(HumanNone=ifelse(ChimpPAS!="None" & HumanPAS=="None", "yes", "no"),ChimpNone=ifelse(ChimpPAS=="None" & HumanPAS!="None", "yes", "no"), EitherNonePatter=ifelse(ChimpNone=="yes" | HumanNone =="yes", "yes","no"))
```

Enrichment for either:  

```{r}
x=nrow(MetaAllSS_diffUsage_add %>% filter(EitherNonePatter=="yes", DiffUsed=="yes"))
m=nrow(MetaAllSS_diffUsage_add %>% filter(DiffUsed=="yes"))
n=nrow(MetaAllSS_diffUsage_add %>% filter(DiffUsed=="no"))
k=nrow(MetaAllSS_diffUsage_add %>% filter(EitherNonePatter=="no"))
N=nrow(MetaAllSS_diffUsage_add)
phyper(x,m,n,k,lower.tail=F)
enrich=(x/k)/(m/N)
enrich
```

Human dir  


```{r}
x=nrow(MetaAllSS_diffUsage_add %>% filter(ChimpNone=="yes", HumanUp=="yes"))
m=nrow(MetaAllSS_diffUsage_add %>% filter(HumanUp=="yes"))
n=nrow(MetaAllSS_diffUsage_add %>% filter(HumanUp=="no"))
k=nrow(MetaAllSS_diffUsage_add %>% filter(ChimpNone=="no"))
N=nrow(MetaAllSS_diffUsage_add)
phyper(x,m,n,k,lower.tail=F)
enrich=(x/k)/(m/N)
enrich
```
Chimp direction  

```{r}
x=nrow(MetaAllSS_diffUsage_add %>% filter(HumanNone=="yes", ChimpUp=="yes"))
m=nrow(MetaAllSS_diffUsage_add %>% filter(ChimpUp=="yes"))
n=nrow(MetaAllSS_diffUsage_add %>% filter(ChimpUp=="no"))
k=nrow(MetaAllSS_diffUsage_add %>% filter(HumanNone=="no"))
N=nrow(MetaAllSS_diffUsage_add)
phyper(x,m,n,k,lower.tail=F)
enrich=(x/k)/(m/N)
enrich
```

None of these are enriched  
```{r}
MetaPAS_diff= MetaPAS %>% mutate(DiffUsed=ifelse(PAS %in% DiffUsed_small$PAS, "yes","no"), HumanNoChimpYes=ifelse(HumanTopSS=="No" & ChimpTopSS=="Yes", "Yes","No"), HumanYesChimpNo=ifelse(HumanTopSS=="Yes" & ChimpTopSS=="No", "Yes","No"), EitherPattern=ifelse(HumanYesChimpNo=="Yes" | HumanNoChimpYes =="Yes", "Yes","No"))
```

Either pattern  

```{r}
x=nrow(MetaPAS_diff %>% filter(EitherPattern=="Yes", DiffUsed=="yes"))
m=nrow(MetaPAS_diff %>% filter(DiffUsed=="yes"))
n=nrow(MetaPAS_diff %>% filter(DiffUsed=="no"))
k=nrow(MetaPAS_diff %>% filter(EitherPattern=="No"))
N=nrow(MetaPAS_diff)
phyper(x,m,n,k,lower.tail=F)
enrich=(x/k)/(m/N)
enrich
```

No enrichment for any of the patterns  
