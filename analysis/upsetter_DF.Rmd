---
title: "Upsetter plot with all phenotypes double fiilter"
author: "Briana Mittleman"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this analysis I will use the UpSetR package to look at all of the differential gene regulation phenotype results in one plot. This should be easier to visualize than the venn diagrams.  


```{r}

library(UpSetR)
library(workflowr)
library(tidyverse)
```



Input the datasets:

```{r}
#protein
Protein=read.table("../data/Khan_prot/HC_SigProtein.txt", header = T, stringsAsFactors = F)
#trans
Translation=read.table("../data/Wang_ribo/HC_SigTranslation.txt", header = T, stringsAsFactors = F)
#expression
nameID=read.table("../../genome_anotation_data/ensemble_to_genename.txt",sep="\t", header = T, stringsAsFactors = F)
DEgenes=read.table("../data/DiffExpression/DE_genes.txt", header = F,col.names = c("Gene_stable_ID"),stringsAsFactors = F) %>% inner_join(nameID, by="Gene_stable_ID") %>% dplyr::select(Gene.name)
#nuclear apa  
NucAPA=read.table("../data/DiffIso_Nuclear_DF/SignifianceEitherGENES_Nuclear.txt",header = T,stringsAsFactors = F)

DSgenes=read.table("../data/DiffSplice_liftedJunc/orderedGeneListFixed.txt",stringsAsFactors = F, col.names = "DS")

```


Create a named list object  


```{r}
listInput_nucOnly <- list(DE=DEgenes$Gene.name, DS=DSgenes$DS, DAPA=NucAPA$gene, DT=Translation$Gene, DP=Protein$gene.symbol)

upset(fromList(listInput_nucOnly), order.by = "freq", keep.order = T,empty.intersections = "on")
```

Add colors for certain queries:

```{r}
#upset(movies, queries = list(list(query = intersects, params = list("Drama", 
#    "Comedy", "Action"), color = "orange", active = T), list(query = intersects, 
 #   params = list("Drama"), color = "red", active = F), list(query = intersects, 
 #   params = list("Action", "Drama"), active = T)))


upset(fromList(listInput_nucOnly), queries = list(list(query=intersects, params=list("DAPA", "DT", "DP"), color="red", active=T,query.name="APA,Ribo, Protein"),list(query=intersects, params=list("DE", "DT", "DP"), color="orange", active=T, query.name="Expression,Ribo, Protein"), list(query=intersects, params=list("DS", "DT", "DP"), color="green", active=T,query.name="Splicing ,Ribo, Protein"),list(query=intersects, params=list("DAPA", "DT"), color="blue", active=T, query.name="APA,Ribo") ,list(query=intersects, params=list("DAPA", "DP"), color="purple", active=T, query.name="APA, Protein")), order.by = "freq", query.legend = "bottom")

```


Will use hypergeometric to test overlaps.  

phyper(success in sample, sucesss in possible, failure possible, sample size)

Success is the overlap, de, not DE, sample size is the apagenes tested in DE 

I need the full lists for this. Not just the significant ones.  


I will start with expression and apa. I need all of the genes tested for both.   

```{r}

DEgenestested=read.table("../data/DiffExpression/DE_Testedgenes.txt", header = F,col.names = c("Gene_stable_ID"),stringsAsFactors = F) %>% inner_join(nameID, by="Gene_stable_ID") %>% dplyr::select(Gene.name)
apaTested=read.table("../data/DiffIso_Nuclear_DF/TN_diff_isoform_allChrom.txt_significance.txt",sep="\t" ,col.names = c('status','loglr','df','p','cluster','p.adjust'),stringsAsFactors = F) %>% filter(status=="Success") %>% separate(cluster, into=c("chr", "Gene.name"),sep=":")

DEtestedandAPA=NucAPA %>%rename("Gene.name"=gene) %>% inner_join(DEgenestested, by="Gene.name") %>% nrow()
DeandAPA=NucAPA %>%rename("Gene.name"=gene) %>%  inner_join(DEgenes, by="Gene.name")%>% nrow()
NotDe= nrow(DEgenestested)-nrow(DEgenes)

  
phyper(DeandAPA, nrow(DEgenes), NotDe, DEtestedandAPA,lower.tail=F)
```

Translation:  
Success is the overlap, T, not T, sample size is the apagenes tested in DE 

```{r}
TranslationTested=read.table("../data/Wang_ribo/HC_AllTestedTranslation.txt",header = T,stringsAsFactors = F) %>% rename("gene"=Gene)
TranslationNotTE= TranslationTested %>% filter(HvC.FDR>=.05)
#actual overlap
TeandAPA=Translation %>% rename("gene"=Gene) %>% inner_join(NucAPA,by="gene")
TranslationTestedandAPA= TranslationTested %>% inner_join(NucAPA,by="gene")

phyper(nrow(TeandAPA), nrow(Translation), nrow(TranslationNotTE), nrow(TranslationTestedandAPA),lower.tail=F)
```

Protein  

Success is the overlap, dp, not no dp, sample size is the apagenes tested in dp  

```{r}
ProtTested=read.table("../data/Khan_prot/HC_AlltestedProtein.txt",header = T,stringsAsFactors = F) %>% rename("gene"=gene.symbol)
nrow(ProtTested)
ProtNotPE= ProtTested %>% filter(HC.qvalues.protein>=.05)
nrow(ProtNotPE)
#actual overlap
PEandAPA=Protein %>% rename("gene"=gene.symbol) %>% inner_join(NucAPA,by="gene")
nrow(PEandAPA)
ProtTestedandAPA= ProtTested %>% inner_join(NucAPA,by="gene")
nrow(ProtTestedandAPA)

phyper(nrow(PEandAPA), nrow(Protein), nrow(ProtNotPE), nrow(ProtTestedandAPA),lower.tail=F)
```


APA, protein, and translation: 

possible hits, not possible 

Success is the overlap, dp and dt, not dp and dt, sample size is the apagenes tested in both dp and dt 


```{r}
ApaProtTrans=PEandAPA  %>% inner_join(TeandAPA, by="gene")

PeandTE=Translation %>% inner_join(Protein) %>% rename("gene"=Gene)

#not dp and dt is all tested in both - pe and te set
PeandTEtested= ProtTested %>% full_join(TranslationTested, by="gene") %>% anti_join(PeandTE,by="gene")
  
apaTestedinboth= ProtTested %>% full_join(TranslationTested, by="gene") %>% inner_join(NucAPA, by="gene")

phyper(nrow(ApaProtTrans), nrow(PeandTE), nrow(PeandTEtested), nrow(apaTestedinboth),lower.tail=F)
```

Expression te and pe  

APA, protein, and translation: 

possible hits, not possible 

Success is the overlap, dp and dt, not dp and dt, sample size is the egenes tested in both dp and dt 


```{r}
Protein_g = Protein %>% rename("gene"=gene.symbol)
translation_g= Translation%>% rename("gene"=Gene)
DEgenes_g= DEgenes %>% rename("gene"=Gene.name)

EProtTrans=DEgenes %>% rename("gene"=Gene.name) %>% inner_join(Protein_g, by="gene") %>% inner_join(translation_g, by="gene")

PeandTE=Translation %>% inner_join(Protein, by = "ENSG") %>% rename("gene"=Gene)

#not dp and dt is all tested in both - pe and te set
PeandTEtested= ProtTested %>% full_join(TranslationTested, by="gene") %>% anti_join(PeandTE,by="gene")
  
expressioninboth= ProtTested %>% full_join(TranslationTested, by="gene") %>% inner_join(DEgenes_g, by="gene")

phyper(nrow(EProtTrans), nrow(PeandTE), nrow(PeandTEtested), nrow(expressioninboth),lower.tail=F)
```


Skipping splicing for now due to gene list problem. 
