---
title: "Signal Site Distribution Double filter"
author: "Briana Mittleman"
date: "1/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Top 2 SS  

In this analysis I will look at the signal site distributions for the human and chimp PAS I have called.  

```{r}
library(ggpubr)
library(workflowr)
library(tidyverse)
```

I am looking at 200 base pair regions for each pas. I will look for the sequence in these for now and then refine the search.  


I can use bedtools nuc on both to get the sequences for the bed files in ../data/PAS.


```{bash,eval=F}
mkdir ../data/SignalSites_doublefilter
sbatch PASsequences_DF.sh
```

The way I did this it flipped the - strand and assayed the correct strand sequence. I will still have to make everything upper case.

Before I use python to find the occurances. I will look at the results because I gave the AATAAA pattern to the nuc program to assay.  

First i have to remove the # in each file


```{r}
humanRawout=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_nuc.txt", stringsAsFactors = F, header = T) %>% mutate(SS=ifelse(X17_user_patt_count>=1, "yes", "no"))
ChimpRawout=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_nuc.txt", stringsAsFactors = F, header = T)%>% mutate(SS=ifelse(X17_user_patt_count>=1, "yes", "no"))
```

Histogram for the results: 


```{r}
ggplot(humanRawout,aes(x=X17_user_patt_count)) + geom_bar(aes(y=..prop..)) +labs(title="Distribution of AATAAA pattern Human")

ggplot(ChimpRawout,aes(x=X17_user_patt_count)) + geom_bar(aes(y=..prop..))+labs(title="Distribution of AATAAA pattern Chimps")

```


See if yes no segragates with usage:

```{r}
ggplot(humanRawout,aes(x=SS,y=X5_usercol,by=SS, fill=SS)) + geom_boxplot() + labs(x="Presence of AATAAA", y="Human mean usage",title="Human usage by presense of at least 1 AATAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test")
```
```{r}

ggplot(ChimpRawout,aes(x=SS,y=X5_usercol,by=SS, fill=SS)) + geom_boxplot() + labs(x="Presence of AATAAA", y="Chimp mean usage",title="Chimp usage by presense of at least 1 AATAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test")
```

Look at location data and bring this in.  

```{r}
Loc=read.table("../data/PAS_doubleFilter/PAS_10perc_either_HumanCoord_BothUsage_meta_doubleFilter.txt", header = T, stringsAsFactors = F) %>% rename("X4_usercol"=PAS) %>% dplyr::select(X4_usercol,loc)

ChimpRawout_withloc=ChimpRawout %>% inner_join(Loc, by="X4_usercol") %>% filter(loc!="008559")
humanRawout_withloc=humanRawout%>% inner_join(Loc, by="X4_usercol") %>% filter(loc!="008559")
```

```{r}

ggplot(humanRawout_withloc,aes(x=loc,y=X5_usercol,by=SS, fill=SS)) + geom_boxplot() + labs(x="Presence of AATAAA", y="Human mean usage",title="Human usage by presense of at least 1 AATAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test",label.y.npc = "bottom")

ggplot(ChimpRawout_withloc,aes(x=loc,y=X5_usercol,by=SS, fill=SS)) + geom_boxplot() + labs(x="Presence of AATAAA", y="Chimp mean usage",title="Chimp usage by presense of at least 1 AATAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test",
label.y.npc = "bottom")
```

I can run the nuc command again for the other doninant signal site I found in the apaQTL analysis (ATTAAA), I can join the results.

```{bash,eval=F}
sbatch PAS_ATTAAA_df.sh
```

**remove #**
```{r}
human_ATTAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_ATTAAA.txt",stringsAsFactors = F,header = T) %>% mutate(SS2=ifelse(X17_user_patt_count>=1, "yes", "no"))

chimp_ATTAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_ATTAAA.txt",stringsAsFactors = F,header = T) %>% mutate(SS2=ifelse(X17_user_patt_count>=1, "yes", "no"))


human_both=human_ATTAAA %>% inner_join(humanRawout_withloc, by=c("X1_usercol", "X2_usercol", "X3_usercol", "X4_usercol", "X5_usercol", "X6_usercol", "X7_pct_at", "X8_pct_gc", "X9_num_A", "X10_num_C", "X11_num_G", "X12_num_T", "X13_num_N", "X14_num_oth", "X15_seq_len", "X16_seq")) %>% mutate(anySS=ifelse(SS == "yes" | SS2 =="yes", "yes", "no"))

chimp_both=chimp_ATTAAA %>% inner_join(ChimpRawout_withloc, by=c("X1_usercol", "X2_usercol", "X3_usercol", "X4_usercol", "X5_usercol", "X6_usercol", "X7_pct_at", "X8_pct_gc", "X9_num_A", "X10_num_C", "X11_num_G", "X12_num_T", "X13_num_N", "X14_num_oth", "X15_seq_len", "X16_seq")) %>% mutate(anySS=ifelse(SS == "yes" | SS2 =="yes", "yes", "no"))


```

```{r}
ggplot(human_both,aes(x=loc,y=X5_usercol,by=SS2, fill=SS2)) + geom_boxplot() + labs(x="Presence of  ATTAAA", y="Human mean usage",title="Human usage by presense of at least 1  ATTAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test",label.y.npc = "bottom")

ggplot(chimp_both,aes(x=loc,y=X5_usercol,by=SS2, fill=SS2)) + geom_boxplot() + labs(x="Presence of ATTAAA", y="Chimp mean usage",title="Chimp usage by presense of at least 1  ATTAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test",
label.y.npc = "bottom")
```



```{r}

ggplot(human_both,aes(x=loc,y=X5_usercol,by=anySS, fill=anySS)) + geom_boxplot() + labs(x="Presence of AATAAA or ATTAAA", y="Human mean usage",title="Human usage by presense of at least 1 AATAAA or ATTAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test",label.y.npc = "bottom")

ggplot(chimp_both,aes(x=loc,y=X5_usercol,by=anySS, fill=anySS)) + geom_boxplot() + labs(x="Presence of AATAAA or ATTAAA", y="Chimp mean usage",title="Chimp usage by presense of at least 1 AATAAA or ATTAAA") + scale_fill_brewer(palette = "Dark2") + stat_compare_means(method = "t.test",
label.y.npc = "bottom")
```

Plot percentage either by loc:

```{r}

human_both_loc= human_both %>% group_by(loc, anySS) %>% summarise(count=n()) %>% ungroup() %>% group_by(loc) %>% mutate(nLoc=sum(count),Human=count/nLoc) %>%ungroup() %>%  dplyr::select(loc, anySS,Human)

chimp_both_loc= chimp_both %>% group_by(loc, anySS) %>% summarise(count=n()) %>% ungroup() %>% group_by(loc) %>% mutate(nLoc=sum(count),Chimp=count/nLoc)%>% ungroup() %>% dplyr::select(loc, anySS,Chimp)

bothSpeciesLoc=chimp_both_loc %>% inner_join(human_both_loc,by=c("loc", "anySS")) %>% gather(key="species", value="propSS", -loc, -anySS) %>% filter(anySS=="yes")


ggplot(bothSpeciesLoc, aes(x=loc, fill=species,y=propSS)) + geom_bar(stat="identity",position = "dodge") +  scale_fill_brewer(palette = "Dark2") + labs(title="Presence of top 2 signal sites by location", x="Proportion with signal site", x="location")
```


Write out information about SS so i can use it for other anaylsis.  

```{r}
human_write=human_both %>% dplyr::select(X4_usercol,SS,SS2,anySS) %>% rename("PAS"=X4_usercol)

write.table(human_write, "../data/SignalSites_doublefilter/HumanPresenceofSS_DF.txt", col.names = T, row.names = F, quote = F)

chimp_write=chimp_both %>% dplyr::select(X4_usercol,SS,SS2,anySS) %>% rename("PAS"=X4_usercol)

write.table(chimp_write,"../data/SignalSites_doublefilter/ChimpPresenceofSS_DF.txt", col.names = T, row.names = F, quote = F)
```

##Expand  

I previously just looked at the top 2 signal sites. Now I will write a loop to run this on the remaining 10.  

AAAAAG AATACA AATAGA AATATA ACTAAA AGTAAA CATAAA GATAAA TATAAA AAAAAA  

```{r}

Human_AATAAA= humanRawout %>% rename("Human_AATAAA"=X17_user_patt_count, "PAS"=X4_usercol) %>% dplyr::select(PAS, Human_AATAAA)

Human_ATTAAA= human_ATTAAA %>% rename("Human_ATTAAA"=X17_user_patt_count, "PAS"=X4_usercol) %>% dplyr::select(PAS, Human_ATTAAA)

Human_AAAAAG=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_AAAAAG.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_AAAAAG")) %>% dplyr::select(PAS, Human_AAAAAG)

Human_AATACA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_AATACA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_AATACA")) %>% dplyr::select(PAS, Human_AATACA)
 
Human_AATAGA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_AATAGA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_AATAGA")) %>% dplyr::select(PAS, Human_AATAGA)
 

Human_AATATA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_AATATA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_AATATA")) %>% dplyr::select(PAS, Human_AATATA)  


Human_ACTAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_ACTAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_ACTAAA")) %>% dplyr::select(PAS, Human_ACTAAA)  

Human_AGTAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_AGTAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_AGTAAA")) %>% dplyr::select(PAS, Human_AGTAAA)  


Human_CATAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_CATAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_CATAAA")) %>% dplyr::select(PAS, Human_CATAAA)  

Human_GATAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_GATAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_GATAAA")) %>% dplyr::select(PAS, Human_GATAAA)  

Human_TATAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_TATAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_TATAAA")) %>% dplyr::select(PAS, Human_TATAAA)  


Human_AAAAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_HumanCoordHummanUsage_AAAAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Human_AAAAAA")) %>% dplyr::select(PAS, Human_AAAAAA)  

```

```{r}

Chimp_AATAAA= ChimpRawout %>% rename("Chimp_AATAAA"=X17_user_patt_count, "PAS"=X4_usercol) %>% dplyr::select(PAS, Chimp_AATAAA)

Chimp_ATTAAA= chimp_ATTAAA %>% rename("Chimp_ATTAAA"=X17_user_patt_count, "PAS"=X4_usercol) %>% dplyr::select(PAS, Chimp_ATTAAA)


Chimp_AAAAAG=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_AAAAAG.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_AAAAAG")) %>% dplyr::select(PAS, Chimp_AAAAAG)

Chimp_AATACA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_AATACA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_AATACA")) %>% dplyr::select(PAS, Chimp_AATACA)
 
Chimp_AATAGA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_AATAGA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_AATAGA")) %>% dplyr::select(PAS, Chimp_AATAGA)
 

Chimp_AATATA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_AATATA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_AATATA")) %>% dplyr::select(PAS, Chimp_AATATA)  


Chimp_ACTAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_ACTAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_ACTAAA")) %>% dplyr::select(PAS, Chimp_ACTAAA)  

Chimp_AGTAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_AGTAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_AGTAAA")) %>% dplyr::select(PAS, Chimp_AGTAAA)  


Chimp_CATAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_CATAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_CATAAA")) %>% dplyr::select(PAS, Chimp_CATAAA)  

Chimp_GATAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_GATAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_GATAAA")) %>% dplyr::select(PAS, Chimp_GATAAA)  

Chimp_TATAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_TATAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_TATAAA")) %>% dplyr::select(PAS, Chimp_TATAAA)  


Chimp_AAAAAA=read.table("../data/SignalSites_doublefilter/PAS_doublefilter_either_ChimpCoordChimpUsage_AAAAAA.txt",stringsAsFactors = F,col.names=c("chr","start", "end", "PAS", "Human", "strand", "pcAT", "pcGC", "A", "C", "G", "T","N","oth", "leng", "Chimp_AAAAAA")) %>% dplyr::select(PAS, Chimp_AAAAAA)  
```

Join all of these by PAS  

```{r}
Human_allPAS=Human_AATAAA %>% inner_join(Human_ATTAAA, by="PAS")  %>% inner_join(Human_AAAAAG, by="PAS")  %>% inner_join(Human_AATACA, by="PAS") %>% inner_join(Human_AATAGA, by="PAS") %>% inner_join(Human_AATATA, by="PAS") %>% inner_join(Human_ACTAAA, by="PAS") %>% inner_join(Human_AGTAAA, by="PAS") %>% inner_join(Human_CATAAA, by="PAS") %>% inner_join(Human_GATAAA, by="PAS") %>% inner_join(Human_TATAAA, by="PAS") %>% inner_join(Human_AAAAAA, by="PAS")


Chimp_allPAS=Chimp_AATAAA %>% inner_join(Chimp_ATTAAA, by="PAS")  %>% inner_join(Chimp_AAAAAG, by="PAS")  %>% inner_join(Chimp_AATACA, by="PAS") %>% inner_join(Chimp_AATAGA, by="PAS") %>% inner_join(Chimp_AATATA, by="PAS") %>% inner_join(Chimp_ACTAAA, by="PAS") %>% inner_join(Chimp_AGTAAA, by="PAS") %>% inner_join(Chimp_CATAAA, by="PAS") %>% inner_join(Chimp_GATAAA, by="PAS") %>% inner_join(Chimp_TATAAA, by="PAS") %>% inner_join(Chimp_AAAAAA, by="PAS")


```

Gather these  

```{r}
Human_allPAS_gather=Human_allPAS %>% gather("Site", "Count",-PAS) %>% mutate(Identified=ifelse(Count>=1, "Y", "N")) %>% separate(Site, into=c("Species", "Signal"), by="_")

Chimp_allPAS_gather=Chimp_allPAS %>% gather("Site", "Count",-PAS) %>% mutate(Identified=ifelse(Count>=1, "Y", "N"))%>% separate(Site, into=c("Species", "Signal"), by="_")

Both_AllPAS_ident= Chimp_allPAS_gather %>% bind_rows(Human_allPAS_gather) %>% filter(Identified=="Y")


Both_AllPAS_group= Both_AllPAS_ident %>% group_by(Species, Signal) %>% summarise(n=n()) %>% mutate(NPAS=42318, propW=n/NPAS)
```


Plot:  

```{r}
ggplot(Both_AllPAS_ident, aes(x=Signal, by=Species, fill=Species)) + geom_bar(stat="count",position = "dodge")+ theme(axis.text.x = element_text(angle = 90)) + scale_fill_brewer(palette = "Dark2")
```
 
```{r}
ggplot(Both_AllPAS_group, aes(x=Signal, by=Species, fill=Species,y=propW)) + geom_bar(stat="identity",position = "dodge")+ theme(axis.text.x = element_text(angle = 90)) + scale_fill_brewer(palette = "Dark2")
```

This is not accounting for more than 1. I need to chose in a hierarchical way. I think I will use these proportions.  

I want to see how many signals are identified per PAS  

```{r}
Chimp_allPAS_gather_site= Chimp_allPAS_gather %>% filter(Identified=="Y") %>% group_by(PAS) %>% summarise(nPerPAS_Chimp=n())

Human_allPAS_gather_site= Human_allPAS_gather %>% filter(Identified=="Y") %>% group_by(PAS) %>% summarise(nPerPAS_Human=n())


BothwithninSite=Chimp_allPAS_gather_site %>% inner_join(Human_allPAS_gather_site, by="PAS")
```

Plot:  

```{r}
ggplot(BothwithninSite, aes(x=nPerPAS_Chimp, y=nPerPAS_Human)) + geom_point() + geom_smooth(method="lm")
```


```{r}
ggplot(BothwithninSite, aes(x=nPerPAS_Chimp)) + geom_bar()

ggplot(BothwithninSite, aes(x=nPerPAS_Human)) + geom_bar()
```

Ok similar distributions. I can hierarchically chose in both with the same parameter.  


